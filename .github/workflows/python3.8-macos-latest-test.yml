name: python-win-11-arm64-diagnostics

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-11-arm

    strategy:
      fail-fast: false
      matrix:
        python-version: [3.12.10, 3.12.9, 3.13.4, 3.13.5, 3.13.7]

    steps:
      - name: Print runner metadata
        shell: pwsh
        run: |
          Write-Host "RUNNER_OS        : $env:RUNNER_OS"
          Write-Host "RUNNER_ARCH      : $env:RUNNER_ARCH"
          Write-Host "ImageOS          : $env:ImageOS"
          Write-Host "ImageVersion     : $env:ImageVersion"

      - name: Inspect Python toolcache BEFORE setup-python
        shell: pwsh
        run: |
          $root = "C:\hostedtoolcache\windows\Python"
          Write-Host "Checking toolcache root: $root"

          if (Test-Path $root) {
            Get-ChildItem $root -Directory | ForEach-Object {
              Write-Host "Found version: $($_.Name)"
              Get-ChildItem $_.FullName -Directory | ForEach-Object {
                Write-Host "  Arch: $($_.Name)"
              }
            }
          } else {
            Write-Host "Python toolcache directory does NOT exist"
          }

      - name: Attempt setup-python (expected to fail on ARM64)
        id: setup
        continue-on-error: true
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: arm64
        env:
          ACTIONS_STEP_DEBUG: true

      - name: Inspect toolcache AFTER setup-python
        shell: pwsh
        run: |
          $expected = "C:\hostedtoolcache\windows\Python\${{ matrix.python-version }}\arm64\python.exe"
          Write-Host "Expected python.exe path:"
          Write-Host $expected

          if (Test-Path $expected) {
            Write-Host "python.exe exists"
          } else {
            Write-Host "python.exe does NOT exist"
          }

      - name: Explain failure (always runs)
        shell: pwsh
        run: |
          Write-Host "Result:"
          Write-Host "- setup-python attempted dynamic installation"
          Write-Host "- No toolcache entry was created"
          Write-Host "- python.exe is missing"
          Write-Host "- Failure is due to runner limitation, not workflow"
