name: Python Artifact Setup

on:
  workflow_dispatch:

jobs:
  setup-python:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [windows-11-arm]
        python-version:
          
          - 3.11.0
          - 3.11.1
          - 3.11.2
          - 3.11.3
          - 3.11.4
          - 3.11.5
          - 3.11.6
          - 3.11.7
          - 3.11.8
          - 3.11.9
          - 3.11.10
          - 3.11.11
          - 3.11.12
          - 3.11.13
          - 3.11.14
          - 3.12.0
          - 3.12.1
          - 3.12.2
          - 3.12.3
          - 3.12.4
          - 3.12.5
          - 3.12.6
          - 3.12.7
          - 3.12.8
          - 3.12.9
          - 3.12.10
          - 3.12.12

          - 3.13.0
          - 3.13.1
          - 3.13.2
          - 3.13.3
          - 3.13.4
          - 3.13.5
          - 3.13.6
          - 3.13.7
          - 3.13.8
          - 3.13.9
          - 3.13.10
          - 3.13.11
          

          - 3.14.0
          - 3.14.1
          - 3.14.0-rc.3

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python (preferred)
        id: setup-python
        uses: actions/setup-python@v5
        continue-on-error: true
        with:
          python-version: ${{ matrix.python-version }}
          architecture: arm64

      - name: Manual Python setup for Windows ARM (fallback)
        if: steps.setup-python.outcome == 'failure'
        shell: pwsh
        run: |
          $PYTHON_VERSION = "${{ matrix.python-version }}"
          Write-Host "setup-python failed, falling back to manual install for $PYTHON_VERSION"

          $BASE_URL = "https://www.python.org/ftp/python"
          $MAJOR_MINOR = $PYTHON_VERSION.Substring(0, $PYTHON_VERSION.LastIndexOf('.'))

          $PAGE = Invoke-WebRequest "$BASE_URL/$MAJOR_MINOR/"
          $ZIP = $PAGE.Links |
            Where-Object href -match "python-$PYTHON_VERSION-arm64\.zip" |
            Select-Object -First 1 -ExpandProperty href

          if (-not $ZIP) {
            throw "No ARM64 zip found for Python $PYTHON_VERSION"
          }

          $ZIP_URL = "$BASE_URL/$MAJOR_MINOR/$ZIP"
          $INSTALL_DIR = "$env:RUNNER_TEMP\Python\$PYTHON_VERSION"

          New-Item -ItemType Directory -Force -Path $INSTALL_DIR | Out-Null
          Invoke-WebRequest -Uri $ZIP_URL -OutFile "$env:RUNNER_TEMP\python.zip"
          Expand-Archive "$env:RUNNER_TEMP\python.zip" -DestinationPath $INSTALL_DIR -Force

          echo "$INSTALL_DIR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8
          echo "$INSTALL_DIR\Scripts" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8

          python --version

      - name: Verify Python
        run: python --version
