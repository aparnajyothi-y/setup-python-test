name: Debug Poetry Sync on Python 3.13

on:
  workflow_dispatch:

jobs:
  reproduce-poetry-sync-delay:
    name: Reproduce Poetry Sync Delay on Py 3.13
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: 3.13

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV

      - name: Create isolated venv
        run: |
          python -m venv .venv
          source .venv/bin/activate

      - name: Install dependencies (poetry sync)
        run: |
          time poetry sync
        shell: bash

      - name: Debug info
        if: failure()
        run: |
          echo "== Poetry version =="
          poetry --version
          echo "== Python version =="
          python --version
          echo "== Installed packages =="
          pip list
          echo "== Diagnostics: disk, memory =="
          df -h
          free -m
